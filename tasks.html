<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1200">
  <title>My Tasks - TaskFlash</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="hcss.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>
  <script src="notifications.js"></script>

  <style>
    .nav-links a {
      text-decoration: none;
      margin: 0 0.8rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .task-container {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .task-filters button {
      margin: 0 0.3rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 0.6rem;
      background: var(--surface);
      cursor: pointer;
      font-weight: 500;
    }

    .task-filters button.active {
      background: var(--primary);
      color: #fff;
    }

    .sort-section select {
      padding: 0.6rem 1rem;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
    }

    .search-bar {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }

    .search-bar input {
      width: 250px;
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.6rem;
    }

    .stats-bar {
      display: flex;
      justify-content: space-around;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .stat-box {
      flex: 1;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    .task-list {
      display: grid;
      gap: 1.2rem;
    }

    .task-card {
      background: var(--surface);
      padding: 1.2rem 1.5rem;
      border-radius: 0.8rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-info h3 {
      margin: 0;
      color: var(--primary-dark);
    }

    .task-info small {
      color: var(--text-secondary);
    }

    .task-actions button {
      margin-left: 0.5rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .task-actions .complete { color: green; }
    .task-actions .delete { color: red; }
    .task-actions .edit { color: #007AFF; }

    /* History Section */
    .history-section {
      margin-top: 3rem;
    }

    .history-section h3 {
      margin-bottom: 1rem;
      color: var(--primary-dark);
    }

    .history-list {
      display: grid;
      gap: 1rem;
    }

    .history-card {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 0.6rem;
    }
    
    /* --- CSS for Expired Tasks --- */
    .task-card.task-expired {
      background-color: #fef2f2;
      border-left: 5px solid #ef4444;
      opacity: 0.8;
    }
    .task-expired h3 { color: #ef4444; }
    .task-expired .task-actions .complete,
    .task-expired .task-actions .edit {
      display: none;
    }
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 1rem;
      color: #fff;
      vertical-align: middle;
      margin-left: 0.5rem;
    }
    .status-badge.expired { background-color: #ef4444; }

    /* --- CSS for Edit Modal --- */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #fefefe; margin: 10% auto; padding: 20px;
      border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 1rem;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 1rem; margin-bottom: 1rem; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.7rem; border-radius: 0.5rem; border: 1px solid #ccc; }
    .form-actions { text-align: right; margin-top: 1.5rem; }
  </style>
</head>

<body>

  <nav class="navbar">
    <div class="nav-content">
      <a href="index.html" class="logo"><i class="fas fa-tasks"></i> TaskFlash</a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="tasks.html" class="active">My Tasks</a>
        <a href="profile.html">Profile</a>
        <a href="analytics.html">Analytics</a>
        <button type="button" class="btn btn-primary" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="task-container">
    <div class="task-header">
      <h2> My Tasks</h2>
      <div class="task-filters">
        <button onclick="filterTasks('all')" class="active">All</button>
        <button onclick="filterTasks('pending')">Pending</button>
        <button onclick="filterTasks('completed')">Completed</button>
      </div>
      <div class="sort-section">
        <select id="sortSelect" onchange="sortTasks()">
          <option value="newest">Due Date (Newest First)</option>
          <option value="oldest">Due Date (Oldest First)</option>
          <option value="urgencyHigh">Urgency (High → Low)</option>
          <option value="urgencyLow">Urgency (Low → High)</option>
        </select>
      </div>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="🔍 Search tasks..." onkeyup="searchTasks()">
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-number" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="pendingTasks">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="completedTasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>

    <div class="available-time" style="margin: 1rem 0; text-align:center;">
      <label for="availableTime"><strong>Available Time (minutes):</strong></label>
      <input type="number" id="availableTime" placeholder="e.g. 30" style="padding:0.5rem; margin-left:0.5rem;">
      <button class="btn btn-primary" onclick="filterByAvailableTime()">Find Tasks</button>
      <button class="btn btn-secondary" onclick="clearAvailableTime()">Clear</button>
    </div>

    <div class="task-list" id="taskList"></div>

    <div class="history-section">
      <h3>Task History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
  
  <script>
    let currentUser = null;
    let currentFilter = 'all';
    let currentSort = 'newest';
    let searchQuery = "";

    document.addEventListener("DOMContentLoaded", async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = "login.html";
        } else {
            currentUser = session.user;
            await initializePage();
        }
    });

    async function initializePage() {
        await loadTasks();
        await requestNotificationPermission();
        setInterval(checkDueTasks, 60000);
        await checkDueTasks();
    }
    
    async function filterByAvailableTime() {
        const available = parseInt(document.getElementById("availableTime").value);
        if (isNaN(available) || available <= 0) return alert("Please enter a valid time in minutes.");

        const { data: suitableTasks, error } = await supabase.from('tasks')
            .select('*').eq('user_id', currentUser.id).eq('completed', false)
            .lte('duration', available).not('duration', 'is', null);

        if (error) return console.error(error);
        renderTasks(suitableTasks.length === 0 ? [] : suitableTasks);
        document.getElementById("taskList").insertAdjacentHTML('afterbegin', suitableTasks.length === 0 ? `<p style="text-align:center;">No tasks can be completed within ${available} minutes.</p>` : '');
    }

    function clearAvailableTime() {
        document.getElementById("availableTime").value = "";
        loadTasks();
    }
    
    async function logout() {
        const { error } = await supabase.auth.signOut();
        if (error) { alert("Error logging out: " + error.message); }
        else { window.location.href = "login.html"; }
    }

    async function loadTasks() {
        if (!currentUser) return;
        let query = supabase.from('tasks').select('*').eq('user_id', currentUser.id);

        if (currentFilter === 'pending') query = query.eq('completed', false);
        else if (currentFilter === 'completed') query = query.eq('completed', true);
        if (searchQuery.trim() !== "") query = query.ilike('name', `%${searchQuery.trim()}%`);
        if (currentSort === 'newest' || currentSort === 'oldest') {
            query = query.order('due_datetime', { ascending: currentSort === 'oldest', nullsFirst: false });
        }
        
        const { data: tasks, error } = await query;
        if (error) return console.error("Error fetching tasks:", error);

        let processedTasks = [...tasks];
        if (currentSort === 'urgencyHigh' || currentSort === 'urgencyLow') {
            const order = { "High": 1, "Medium": 2, "Low": 3 };
            processedTasks.sort((a, b) => currentSort === 'urgencyHigh' ? (order[a.urgency] || 99) - (order[b.urgency] || 99) : (order[b.urgency] || 99) - (order[a.urgency] || 99));
        }
        
        document.getElementById("totalTasks").innerText = tasks.length;
        document.getElementById("pendingTasks").innerText = tasks.filter(t => !t.completed).length;
        document.getElementById("completedTasks").innerText = tasks.filter(t => t.completed).length;

        renderTasks(processedTasks);
        
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "";
        tasks.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(task => {
            const card = document.createElement("div");
            card.className = "history-card";
            card.innerHTML = `<strong>${task.name}</strong> [${task.urgency}]<br><small>Created: ${new Date(task.created_at).toLocaleString()}</small><br><small>Completed: ${task.completed ? (task.completed_on ? new Date(task.completed_on).toLocaleString() : "Yes") : "Not yet"}</small>`;
            historyList.appendChild(card);
        });
    }

    function renderTasks(tasksToRender) {
        const list = document.getElementById("taskList");
        list.innerHTML = tasksToRender.length === 0 ? "<p style='text-align:center;'>No tasks found.</p>" : "";
        if (tasksToRender.length === 0) return;

        const now = new Date();
        tasksToRender.forEach(task => {
            const card = document.createElement("div");
            card.className = "task-card";
            const dueTime = task.due_datetime ? new Date(task.due_datetime) : null;
            const isExpired = !task.completed && dueTime && now > dueTime;
            let statusBadge = '';
            if (isExpired) {
                card.classList.add("task-expired");
                statusBadge = `<span class="status-badge expired">Expired</span>`;
            }

            const info = document.createElement("div");
            info.className = "task-info";
            info.innerHTML = `<h3>${task.name} ${statusBadge} <small>[${task.urgency}]</small></h3><small>⏳ ${task.duration || "N/A"} mins | 📅 ${dueTime ? dueTime.toLocaleString() : "Not set"}</small>`;
            
            const actions = document.createElement("div");
            actions.className = "task-actions";
            actions.innerHTML = `
                <button class="complete" onclick="toggleComplete('${task.id}', ${task.completed})"><i class="fas fa-check-circle"></i></button>
                <button class="edit" onclick="openEditModal('${task.id}')"><i class="fas fa-pencil-alt"></i></button>
                <button class="delete" onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i></button>
            `;
            
            card.appendChild(info);
            card.appendChild(actions);
            list.appendChild(card);
        });
    }

    function filterTasks(type) {
        currentFilter = type;
        document.querySelectorAll('.task-filters button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase() === type) btn.classList.add('active');
        });
        loadTasks();
    }

    function sortTasks() {
        currentSort = document.getElementById("sortSelect").value;
        loadTasks();
    }

    function searchTasks() {
        searchQuery = document.getElementById("searchInput").value;
        loadTasks();
    }

    async function toggleComplete(taskId, currentStatus) {
        const { error } = await supabase.from('tasks')
            .update({ completed: !currentStatus, completed_on: !currentStatus ? new Date().toISOString() : null })
            .eq('id', taskId);
        if (error) alert("Error updating task: " + error.message);
        else loadTasks();
    }

    async function deleteTask(taskId) {
        if (confirm("Are you sure you want to delete this task?")) {
            const { error } = await supabase.from('tasks').delete().eq('id', taskId);
            if (error) alert("Error deleting task: " + error.message);
            else loadTasks();
        }
    }

    // --- JAVASCRIPT FOR EDIT MODAL ---
    async function openEditModal(taskId) {
        const { data: task, error } = await supabase.from('tasks').select('*').eq('id', taskId).single();
        if (error) return alert("Error fetching task details.");
        
        document.getElementById('editTaskId').value = task.id;
        document.getElementById('editTaskName').value = task.name;
        document.getElementById('editTaskUrgency').value = task.urgency;
        document.getElementById('editTaskDuration').value = task.duration;
        
        if (task.due_datetime) {
            const d = new Date(task.due_datetime);
            const localDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            document.getElementById('editTaskDatetime').value = localDate.toISOString().slice(0, 16);
        } else {
            document.getElementById('editTaskDatetime').value = '';
        }
        document.getElementById('editTaskModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editTaskModal').style.display = 'none';
    }

    async function saveTaskChanges() {
        const taskId = document.getElementById('editTaskId').value;
        const name = document.getElementById('editTaskName').value;
        if (!name) return alert("Task name cannot be empty.");
        
        const updatedTask = {
            name: name,
            urgency: document.getElementById('editTaskUrgency').value,
            duration: parseInt(document.getElementById('editTaskDuration').value) || null,
            due_datetime: document.getElementById('editTaskDatetime').value ? new Date(document.getElementById('editTaskDatetime').value).toISOString() : null,
        };

        const { error } = await supabase.from('tasks').update(updatedTask).eq('id', taskId);
        if (error) alert("Error updating task: " + error.message);
        else {
            closeEditModal();
            await loadTasks();
        }
    }
  </script>

  <div id="editTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Task</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form onsubmit="event.preventDefault(); saveTaskChanges();">
          <input type="hidden" id="editTaskId">
          <div class="form-group">
            <label for="editTaskName">Task Name</label>
            <input type="text" id="editTaskName" required>
          </div>
          <div class="form-group">
            <label for="editTaskUrgency">Urgency</label>
            <select id="editTaskUrgency">
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editTaskDuration">Duration (minutes)</label>
            <input type="number" id="editTaskDuration">
          </div>
          <div class="form-group">
            <label for="editTaskDatetime">Due Date & Time</label>
            <input type="datetime-local" id="editTaskDatetime">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>
</html>