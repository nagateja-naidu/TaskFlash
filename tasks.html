<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tasks - TaskFlash</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="hcss.css">

  <style>
    .nav-links a {
      text-decoration: none;
      margin: 0 0.8rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .task-container {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .task-filters button {
      margin: 0 0.3rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 0.6rem;
      background: var(--surface);
      cursor: pointer;
      font-weight: 500;
    }

    .task-filters button.active {
      background: var(--primary);
      color: #fff;
    }

    .sort-section select {
      padding: 0.6rem 1rem;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
    }

    .search-bar {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }

    .search-bar input {
      width: 250px;
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.6rem;
    }

    .stats-bar {
      display: flex;
      justify-content: space-around;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .stat-box {
      flex: 1;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    .task-list {
      display: grid;
      gap: 1.2rem;
    }

    .task-card {
      background: var(--surface);
      padding: 1.2rem 1.5rem;
      border-radius: 0.8rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-info h3 {
      margin: 0;
      color: var(--primary-dark);
    }

    .task-info small {
      color: var(--text-secondary);
    }

    .task-actions button {
      margin-left: 0.5rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .task-actions .complete {
      color: green;
    }

    .task-actions .delete {
      color: red;
    }

    /* History Section */
    .history-section {
      margin-top: 3rem;
    }

    .history-section h3 {
      margin-bottom: 1rem;
      color: var(--primary-dark);
    }

    .history-list {
      display: grid;
      gap: 1rem;
    }

    .history-card {
      background: var(--surface);
      padding: 1rem;
      border-radius: 0.6rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .history-card small {
      color: var(--text-secondary);
    }
  </style> 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabaseClient.js"></script>

</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-content">
      <a href="index.html" class="logo">
        <i class="fas fa-tasks"></i> TaskFlash
      </a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="tasks.html" class="active">My Tasks</a>
        <a href="profile.html">Profile</a>
        <a href="analytics.html">Analytics</a>
        <button type="button" class="btn btn-primary" onclick="logout()">Logout</button>

      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="task-container">
    <div class="task-header">
      <h2> My Tasks</h2>
      <div class="task-filters">
        <button onclick="filterTasks('all')" class="active">All</button>
        <button onclick="filterTasks('pending')">Pending</button>
        <button onclick="filterTasks('completed')">Completed</button>
      </div>
      <div class="sort-section">
        <select id="sortSelect" onchange="sortTasks()">
          <option value="newest">Due Date (Newest First)</option>
          <option value="oldest">Due Date (Oldest First)</option>
          <option value="urgencyHigh">Urgency (High → Low)</option>
          <option value="urgencyLow">Urgency (Low → High)</option>
        </select>
      </div>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="🔍 Search tasks..." onkeyup="searchTasks()">
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-number" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="pendingTasks">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="completedTasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>
    <!-- tasks searching with available time-->
    <div class="available-time" style="margin: 1rem 0; text-align:center;">
      <label for="availableTime"><strong>Available Time (minutes):</strong></label>
      <input type="number" id="availableTime" placeholder="e.g. 30" style="padding:0.5rem; margin-left:0.5rem;">
      <button class="btn btn-primary" onclick="filterByAvailableTime()">Find Tasks</button>
      <button class="btn btn-secondary" onclick="clearAvailableTime()">Clear</button>
    </div>


    <!-- Task List -->
    <div class="task-list" id="taskList"></div>

    <!-- History Section -->
    <div class="history-section">
      <h3>Task History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentFilter = 'all';
    let currentSort = 'newest';
    let searchQuery = "";

    // --- NOTIFICATION SCRIPT ADDED ---
    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }

    async function sendNotification(title, message) {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification(title, { body: message, icon: "https://cdn-icons-png.flaticon.com/512/992/992700.png" });
        }
        if (currentUser) {
            const newNote = {
                user_id: currentUser.id,
                title,
                message,
                seen: false
            };
            const { error } = await supabase.from('notifications').insert(newNote);
            if (error) console.error("Error saving notification:", error);
        }
    }

    async function checkDueTasks() {
        if (!currentUser || !currentUser.id) { return; }
        const now = new Date();
        const { data: allPendingTasks, error: fetchError } = await supabase.from('tasks')
            .select('id, name, due_datetime, notified1hr, notifieddue')
            .eq('user_id', currentUser.id)
            .eq('completed', false);

        if (fetchError) { return; }
        if (!allPendingTasks || allPendingTasks.length === 0) { return; }

        const tasksToNotifyNow = [];
        const tasksToNotify1hr = [];

        allPendingTasks.forEach(task => {
            if (!task.due_datetime) return;
            const dueTime = new Date(task.due_datetime);
            const diffMinutes = Math.round((dueTime - now) / 60000);

            if (diffMinutes <= 0 && !task.notifieddue) {
                tasksToNotifyNow.push(task);
            }
            if (diffMinutes <= 60 && diffMinutes > 0 && !task.notified1hr) {
                tasksToNotify1hr.push(task);
            }
        });

        if (tasksToNotifyNow.length > 0) {
            const taskIds = tasksToNotifyNow.map(t => t.id);
            const { data: updated, error } = await supabase
                .from('tasks')
                .update({ notifieddue: true })
                .in('id', taskIds)
                .select();
            if (updated && !error) {
                updated.forEach(task => {
                    sendNotification("⚡ Task Due Now", `${task.name} is due right now!`);
                });
            }
        }

        if (tasksToNotify1hr.length > 0) {
            const taskIds = tasksToNotify1hr.map(t => t.id);
            const { data: updated, error } = await supabase
                .from('tasks')
                .update({ notified1hr: true })
                .in('id', taskIds)
                .select();
            if (updated && !error) {
                updated.forEach(task => {
                    sendNotification("⏳ Upcoming Task", `${task.name} is due in about an hour!`);
                });
            }
        }
    }
    // --- END OF NOTIFICATION SCRIPT ---

    document.addEventListener("DOMContentLoaded", async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = "login.html";
        } else {
            currentUser = session.user;
            await initializePage();
        }
    });

    async function initializePage() {
        await loadTasks();

        // --- NOTIFICATION TIMER STARTED ---
        await requestNotificationPermission();
        setInterval(checkDueTasks, 60000); // Check every minute
        await checkDueTasks(); // Also check once on page load
    }
    
    async function filterByAvailableTime() {
        const available = parseInt(document.getElementById("availableTime").value);
        if (isNaN(available) || available <= 0) {
            alert("Please enter a valid time in minutes.");
            return;
        }

        const { data: suitableTasks, error } = await supabase.from('tasks')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('completed', false)
            .lte('duration', available)
            .not('duration', 'is', null);

        if (error) { console.error(error); return; }

        const list = document.getElementById("taskList");
        list.innerHTML = "";

        if (suitableTasks.length === 0) {
            list.innerHTML = `<p>No tasks can be completed within ${available} minutes.</p>`;
        } else {
            renderTasks(suitableTasks);
        }
    }

    function clearAvailableTime() {
        document.getElementById("availableTime").value = "";
        loadTasks();
    }
    
    async function logout() {
        const { error } = await supabase.auth.signOut();
        if (error) { alert("Error logging out: " + error.message); }
        else {
            alert("Logged out successfully!");
            window.location.href = "login.html";
        }
    }

    async function loadTasks() {
        if (!currentUser) return;

        let query = supabase.from('tasks')
            .select('*')
            .eq('user_id', currentUser.id);

        if (currentFilter === 'pending') {
            query = query.eq('completed', false);
        } else if (currentFilter === 'completed') {
            query = query.eq('completed', true);
        }

        if (searchQuery.trim() !== "") {
            query = query.ilike('name', `%${searchQuery.trim()}%`);
        }

        if (currentSort === 'newest' || currentSort === 'oldest') {
            query = query.order('due_datetime', { 
                ascending: currentSort === 'oldest', 
                nullsFirst: false 
            });
        }
        
        const { data: tasks, error } = await query;
        if (error) { console.error("Error fetching tasks:", error); return; }

        let processedTasks = [...tasks];

        if (currentSort === 'urgencyHigh' || currentSort === 'urgencyLow') {
            const order = { "High": 1, "Medium": 2, "Low": 3 };
            processedTasks.sort((a, b) => {
                return currentSort === 'urgencyHigh'
                    ? (order[a.urgency] || 99) - (order[b.urgency] || 99)
                    : (order[b.urgency] || 99) - (order[a.urgency] || 99);
            });
        }
        
        document.getElementById("totalTasks").innerText = tasks.length;
        document.getElementById("pendingTasks").innerText = tasks.filter(t => !t.completed).length;
        document.getElementById("completedTasks").innerText = tasks.filter(t => t.completed).length;

        renderTasks(processedTasks);
        
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "";
        tasks
          .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach(task => {
            const card = document.createElement("div");
            card.className = "history-card";
            card.innerHTML = `
                <strong>${task.name}</strong> [${task.urgency}]<br>
                Created: ${new Date(task.created_at).toLocaleString()}<br>
                Completed: ${task.completed ? (task.completed_on ? new Date(task.completed_on).toLocaleString() : "Yes") : "Not yet"}
            `;
            historyList.appendChild(card);
        });
    }

    function renderTasks(tasksToRender) {
        const list = document.getElementById("taskList");
        list.innerHTML = "";
        
        if (tasksToRender.length === 0) {
            list.innerHTML = "<p>No tasks found.</p>";
            return;
        }

        tasksToRender.forEach(task => {
            const card = document.createElement("div");
            card.className = "task-card";

            const info = document.createElement("div");
            info.className = "task-info";
            info.innerHTML = `
                <h3>${task.name} <small>[${task.urgency}]</small></h3>
                <small>⏳ ${task.duration || "N/A"} mins | 📅 ${task.due_datetime ? new Date(task.due_datetime).toLocaleString() : "Not set"}</small>
            `;

            const actions = document.createElement("div");
            actions.className = "task-actions";
            actions.innerHTML = `
                <button class="complete" onclick="toggleComplete('${task.id}', ${task.completed})">
                    <i class="fas fa-check-circle"></i>
                </button>
                <button class="delete" onclick="deleteTask('${task.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            card.appendChild(info);
            card.appendChild(actions);
            list.appendChild(card);
        });
    }

    function filterTasks(type) {
        currentFilter = type;
        document.querySelectorAll('.task-filters button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase() === type) {
                btn.classList.add('active');
            }
        });
        loadTasks();
    }

    function sortTasks() {
        currentSort = document.getElementById("sortSelect").value;
        loadTasks();
    }

    function searchTasks() {
        searchQuery = document.getElementById("searchInput").value;
        loadTasks();
    }

    async function toggleComplete(taskId, currentStatus) {
        const newStatus = !currentStatus;
        
        const { error } = await supabase.from('tasks')
            .update({
                completed: newStatus,
                completed_on: newStatus ? new Date().toISOString() : null
            })
            .eq('id', taskId)
            .eq('user_id', currentUser.id);

        if (error) { alert("Error updating task: " + error.message); }
        else { loadTasks(); }
    }

    async function deleteTask(taskId) {
        if (!confirm("Are you sure you want to delete this task?")) return;

        const { error } = await supabase.from('tasks')
            .delete()
            .eq('id', taskId)
            .eq('user_id', currentUser.id);

        if (error) { alert("Error deleting task: " + error.message); }
        else { loadTasks(); }
    }
</script>
</body>

</html>